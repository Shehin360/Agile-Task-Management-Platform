<div class="page">
  <!-- USER BAR -->
  <div class="user-bar">
    <h1 class="title">Sprintly</h1>
    <div class="user-info">
      <span class="user-avatar">üë§</span>
      <span class="user-name">{{ currentUser()?.displayName }}</span>
      <button class="logout-btn" (click)="logout()">Logout ‚Üí</button>
    </div>
  </div>

  <!-- TOOLBAR: SEARCH + SORT -->
  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input
        class="search-input"
        type="text"
        placeholder="Search tasks..."
        [value]="searchQuery()"
        (input)="searchQuery.set($any($event.target).value)"
      />
      @if (searchQuery()) {
      <button class="search-clear" (click)="searchQuery.set('')">‚úï</button>
      }
    </div>
    <button class="sort-btn" [class]="'sort-active-' + sortMode()" (click)="cycleSortMode()">
      <span class="sort-icon">{{ sortLabel() }}</span>
      <span class="sort-hint">Click to change sort</span>
    </button>
  </div>

  <div class="board">
    <!-- DYNAMIC COLUMNS -->
    @for (column of columns(); track column.id) {
    <div
      class="column"
      [class.drag-over]="dragOverColumn() === column.id"
      (dragover)="onDragOver($event, column.id)"
      (dragleave)="onDragLeave()"
      (drop)="onDrop($event, column.id)"
    >
      <!-- Column Header with dynamic color -->
      <div
        class="column-header"
        [style.background]="getColumnColor(column.colorIndex).gradient"
        [style.box-shadow]="'0 4px 20px ' + getColumnColor(column.colorIndex).glow"
      >
        @if (editingColumnId() === column.id) {
        <div class="column-header-edit">
          <input
            class="column-name-input"
            type="text"
            [value]="editingColumnName()"
            (input)="editingColumnName.set($any($event.target).value)"
            (keyup.enter)="saveEditColumn()"
            (keyup.escape)="cancelEditColumn()"
          />
          <button class="col-action-btn col-save-btn" (click)="saveEditColumn()">‚úì</button>
          <button class="col-action-btn col-cancel-btn" (click)="cancelEditColumn()">‚úï</button>
        </div>
        } @else {
        <div class="column-header-content">
          <span class="column-header-title">{{ column.name }}</span>
          <span class="column-task-count">{{ getColumnTasks(column.id).length }}</span>
        </div>
        <div class="column-header-actions">
          <button
            class="col-action-btn col-edit-btn"
            (click)="startEditColumn(column)"
            title="Rename column"
          >
            ‚úèÔ∏è
          </button>
          @if (columns().length > 1) {
          <button
            class="col-action-btn col-delete-btn"
            (click)="showDeleteColumnConfirm.set(column.id)"
            title="Delete column"
          >
            üóëÔ∏è
          </button>
          }
        </div>
        }
      </div>

      <div class="column-body">
        @for (task of getColumnTasks(column.id); track task.id) {
        <div
          class="task"
          @taskAnim
          draggable="true"
          [class.dragging]="draggedTaskId() === task.id"
          [class.drop-target]="dropTargetTaskId() === task.id"
          (dragstart)="onDragStart($event, task.id)"
          (dragend)="onDragEnd()"
          (dragover)="onDragOverTask($event, task.id)"
          [style.--col-accent]="getColumnColor(column.colorIndex).accent"
        >
          <div class="task-content">
            <div class="task-header">
              <span class="task-title">{{ task.title }}</span>
              <span class="priority-badge" [class]="'priority-' + task.priority">
                {{ task.priority.toUpperCase() }}
              </span>
            </div>
            @if (task.description) {
            <span class="task-description">{{ task.description }}</span>
            } @if (task.dueDate) {
            <span class="due-date-badge" [class]="'due-' + getDueDateStatus(task.dueDate)">
              üìÖ {{ formatDueDate(task.dueDate) }}
            </span>
            }
          </div>
          <div class="task-actions">
            <button class="task-btn edit-btn" (click)="startEdit(task)">‚úèÔ∏è</button>
            <button class="task-btn delete-btn" (click)="showDeleteTaskConfirm.set(task.id)">
              üóëÔ∏è
            </button>
          </div>
        </div>
        } @empty {
        <div class="empty-state">
          <span class="empty-icon">üìã</span>
          <span class="empty-text">No tasks yet</span>
          <span class="empty-hint">Click "+ Add Task" below to get started</span>
        </div>
        }
      </div>

      <!-- Add task button per column -->
      <button
        class="column-add-btn"
        [style.--btn-accent]="getColumnColor(column.colorIndex).accent"
        (click)="openAddTaskModal(column.id)"
      >
        + Add Task
      </button>
    </div>
    }

    <!-- ADD COLUMN CARD -->
    <div class="add-column-card" (click)="showAddColumnModal.set(true)">
      <span class="add-column-icon">Ôºã</span>
      <span class="add-column-text">Add Column</span>
    </div>
  </div>

  <!-- DELETE COLUMN CONFIRMATION -->
  @if (showDeleteColumnConfirm()) {
  <div class="modal-backdrop" (click)="showDeleteColumnConfirm.set(null)">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header modal-header-danger">
        <h2>Delete Column</h2>
        <button class="modal-close" (click)="showDeleteColumnConfirm.set(null)">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="confirm-text">
          Are you sure you want to delete this column? All tasks will be moved to the first
          remaining column.
        </p>
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" (click)="showDeleteColumnConfirm.set(null)">Cancel</button>
        <button class="modal-btn danger" (click)="deleteColumn(showDeleteColumnConfirm()!)">
          Delete
        </button>
      </div>
    </div>
  </div>
  }

  <!-- DELETE TASK CONFIRMATION -->
  @if (showDeleteTaskConfirm()) {
  <div class="modal-backdrop" (click)="showDeleteTaskConfirm.set(null)">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header modal-header-danger">
        <h2>Delete Task</h2>
        <button class="modal-close" (click)="showDeleteTaskConfirm.set(null)">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="confirm-text">
          Are you sure you want to delete <strong>"{{ getDeleteTaskTitle() }}"</strong>? This action
          cannot be undone.
        </p>
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" (click)="showDeleteTaskConfirm.set(null)">Cancel</button>
        <button class="modal-btn danger" (click)="confirmDeleteTask()">Delete</button>
      </div>
    </div>
  </div>
  }

  <!-- ADD COLUMN MODAL -->
  @if (showAddColumnModal()) {
  <div class="modal-backdrop" (click)="showAddColumnModal.set(false)">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add New Column</h2>
        <button class="modal-close" (click)="showAddColumnModal.set(false)">‚úï</button>
      </div>
      <div class="modal-body">
        <label class="modal-label">Column Name</label>
        <input
          class="modal-input"
          type="text"
          placeholder="e.g. In Review, QA, Blocked..."
          [value]="newColumnName()"
          (input)="newColumnName.set($any($event.target).value)"
          (keyup.enter)="addColumn()"
        />
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" (click)="showAddColumnModal.set(false)">Cancel</button>
        <button class="modal-btn add" (click)="addColumn()">Add Column</button>
      </div>
    </div>
  </div>
  }

  <!-- ADD TASK MODAL -->
  @if (showAddTaskModal()) {
  <div class="modal-backdrop" (click)="showAddTaskModal.set(false)">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add New Task</h2>
        <button class="modal-close" (click)="showAddTaskModal.set(false)">‚úï</button>
      </div>

      <div class="modal-body">
        <label class="modal-label">Title</label>
        <input
          class="modal-input"
          type="text"
          placeholder="Enter task title..."
          [value]="newTaskTitle()"
          (input)="newTaskTitle.set($any($event.target).value)"
          (keyup.enter)="addTask(); showAddTaskModal.set(false)"
        />

        <label class="modal-label">Description</label>
        <textarea
          class="modal-textarea"
          placeholder="Enter description (optional)..."
          [value]="newTaskDescription()"
          (input)="newTaskDescription.set($any($event.target).value)"
        ></textarea>

        <label class="modal-label">Priority</label>
        <select
          class="modal-select"
          [value]="newTaskPriority()"
          (change)="newTaskPriority.set($any($event.target).value)"
        >
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>

        <label class="modal-label">Due Date</label>
        <input
          class="modal-input modal-date"
          type="date"
          [value]="newTaskDueDate() || ''"
          (input)="newTaskDueDate.set($any($event.target).value || null)"
        />
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" (click)="showAddTaskModal.set(false)">Cancel</button>
        <button class="modal-btn add" (click)="addTask(); showAddTaskModal.set(false)">
          Add Task
        </button>
      </div>
    </div>
  </div>
  }

  <!-- EDIT TASK MODAL -->
  @if (showEditTaskModal()) {
  <div class="modal-backdrop" (click)="cancelEdit()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit Task</h2>
        <button class="modal-close" (click)="cancelEdit()">‚úï</button>
      </div>

      <div class="modal-body">
        <label class="modal-label">Title</label>
        <input
          class="modal-input"
          type="text"
          placeholder="Enter task title..."
          [value]="editingTitle()"
          (input)="editingTitle.set($any($event.target).value)"
          (keyup.enter)="saveEdit(editingTaskId()!)"
          (keyup.escape)="cancelEdit()"
        />

        <label class="modal-label">Description</label>
        <textarea
          class="modal-textarea"
          placeholder="Enter description (optional)..."
          [value]="editingDescription()"
          (input)="editingDescription.set($any($event.target).value)"
          (keyup.escape)="cancelEdit()"
        ></textarea>

        <label class="modal-label">Priority</label>
        <select
          class="modal-select"
          [value]="editingPriority()"
          (change)="editingPriority.set($any($event.target).value)"
        >
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>

        <label class="modal-label">Due Date</label>
        <input
          class="modal-input modal-date"
          type="date"
          [value]="editingDueDate() || ''"
          (input)="editingDueDate.set($any($event.target).value || null)"
        />
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" (click)="cancelEdit()">Cancel</button>
        <button class="modal-btn add" (click)="saveEdit(editingTaskId()!)">Save Changes</button>
      </div>
    </div>
  </div>
  }

  <!-- TOAST NOTIFICATIONS -->
  <div class="toast-container">
    @for (toast of toasts(); track toast.id) {
    <div class="toast" [class]="'toast-' + toast.type" @toastAnim (click)="dismissToast(toast.id)">
      <span class="toast-icon">{{ toast.icon }}</span>
      <span class="toast-text">{{ toast.text }}</span>
      <button class="toast-close" (click)="dismissToast(toast.id); $event.stopPropagation()">
        ‚úï
      </button>
    </div>
    }
  </div>

  <!-- LOGOUT CONFIRMATION MODAL -->
  @if (showLogoutConfirm()) {
  <div class="modal-overlay" (click)="cancelLogout()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-icon">üëã</div>
      <h3 class="modal-title">Leaving so soon?</h3>
      <p class="modal-message">Are you sure you want to log out of your workspace?</p>
      <div class="modal-actions">
        <button class="modal-btn modal-cancel-btn" (click)="cancelLogout()">Cancel</button>
        <button class="modal-btn modal-logout-btn" (click)="confirmLogout()">Logout</button>
      </div>
    </div>
  </div>
  }
</div>
